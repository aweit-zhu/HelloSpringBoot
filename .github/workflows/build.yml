name: Build and Test Spring Boot App

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: self-hosted

    steps:
      # 1️⃣ 檢出你的程式碼
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2️⃣ 設定 Java 環境（例如 JDK 17）
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'   # 可用 'zulu'、'corretto' 等

      # 3️⃣ 使用 Maven 編譯與測試
      - name: Build with Maven
        run: mvn -B clean verify

      # 4️⃣ 可選：打包 Spring Boot jar
      - name: Package Spring Boot Jar
        run: mvn -B clean package -DskipTests

      # 5️⃣ 可選：上傳編譯後的 jar 檔作為 artifact
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-jar
          path: target/*.jar

      # 6️⃣ 自動執行 JAR
      - name: Run Spring Boot App
        run: |
          echo "啟動 Spring Boot 應用程式..."
          nohup java -jar target/*.jar > app.log 2>&1 &